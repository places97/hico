<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Thymeleaf 테스트</title>
  <!--  <script th:src="@{/js/jquery/jquery-3.7.1.min.js}"></script>-->
  <script src="/js/jquery/jquery-3.7.1.min.js"></script>
  <script src="/js/jsrender/jsrender.min.js"></script>
</head>
<style>
  #data-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }

  #data-table th, #data-table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
  }
</style>
<body>
<div>
  <input id="ipt" type="text" placeholder="입력 값"/>
  <button id="btn">입력</button>
  <button id="reset">초기화</button>
  <button id="sel">조회</button>
  <button id="move">이동</button>
  <button id="err">에러발생</button>
  <br>
  <input id="rst" type="text" readonly placeholder="결과 값"/>
</div>

<h2 style="margin-top: 20px;">조회 결과 목록</h2>
<table id="data-table">
  <thead>
  <tr>
    <th>순번</th>
    <th>제목</th>
    <th>날짜</th>
  </tr>
  </thead>
  <tbody>
  <tr>
    <td colspan="3" style="text-align: center;">조회 버튼을 눌러 데이터를 가져오세요.</td>
  </tr>
  </tbody>
</table>

<script id="dataRowTmpl" type="text/x-jsrender">
  <tr>
    <td>{{: #index + 1}}</td>
    <td>{{: testContent}}</td>
    <td>{{: regDate}}</td>
   </tr>
</script>

</body>
</html>

<script type="text/javascript">
  $(document).ready(function () {
    fnAddEvent(); // 페이지 이벤트 추가
  });

  function fnAddEvent() {
    $('#btn').on('click', fnRegister);
    $('#reset').on('click', fnReset);
    $('#sel').on('click', fnList);
    $('#move').on('click', fnMove);
    $('#err').on('click', fnErr);
  }

  function fnMove() {
    window.location.href = '/test/page.do';
  }

  function fnRegister() {
    let result = $('#ipt').val();
    $('#rst').val(result);
  }

  function fnReset() {
    $('#rst').val("");
  }

  /**
   * 목록 조회 및 테이블 그리기 함수 (JsRender 사용)
   */
  function fnList() {
    $.ajax({
      url: '/test/list.do', // 서버의 목록 조회 URL
      type: 'GET',
      dataType: 'json',
      contentType: 'application/json; charset=utf-8',
      data: {},

      success: function (response) {
        console.log("목록 조회 성공:", response);
        var dataList = response.data;

        fnRenderTable(dataList);

        alert("조회 성공");
      },
      error: function (response) {
        var errorResultVo = JSON.parse(response.responseText);
        console.error("서버 에러 응답 (ResultVo):", errorResultVo);
        alert("에러 발생: " + errorResultVo.resMsg);
      }
    });
  }

  /**
   * JsRender 템플릿을 사용하여 데이터를 테이블에 렌더링하는 함수
   * @param dataList - 서버에서 받은 데이터 배열 (testVo)
   */
  function fnRenderTable(dataList) {
    let $tbody = $('#data-table tbody');
    $tbody.empty(); // 기존 내용을 모두 비웁니다.

    if (dataList && dataList.length > 0) {
      // 1. 템플릿 컴파일 (최초 1회만 필요)
      let template = $.templates("#dataRowTmpl");

      // 2. 데이터 렌더링
      // dataList(배열)을 템플릿에 넣어 HTML 문자열을 생성합니다.
      let htmlOutput = template.render(dataList);

      // 3. 테이블에 삽입
      $tbody.append(htmlOutput);
    } else {
      // 데이터가 없을 경우
      let noDataHtml = '<tr><td colspan="4" style="text-align: center;">조회된 데이터가 없습니다.</td></tr>';
      $tbody.append(noDataHtml);
    }
  }

  function fnErr() {
    $.ajax({
      url: '/test/error-test.do',
      type: 'GET',
      dataType: 'json',
      contentType: 'application/json; charset=utf-8',
      data: {},
      timeout: 120000,
      success: function (response) {
        console.log("목록 조회 성공:", response);
        alert("조회 성공");
      },
      error: function (response) {
        var errorResultVo = JSON.parse(response.responseText);
        console.error("서버 에러 응답 (ResultVo):", errorResultVo);
        alert("에러 발생: " + errorResultVo.resMsg);
      }
    });
  }
</script>